<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Tourism Reports PRO</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #eef2f7; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; width: 400px; }
        h2 { color: #2c3e50; margin-bottom: 25px; }
        .btn { display: block; padding: 15px; margin: 10px 0; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; border: none; text-decoration: none; transition: 0.3s; }
        .btn-arr { background: #27ae60; }
        .btn-arr:hover { background: #219150; }
        .btn-dep { background: #2980b9; }
        .btn-dep:hover { background: #2471a3; }
        input[type="file"] { display: none; }
        #status { margin-top: 20px; color: #7f8c8d; font-size: 14px; }
    </style>
</head>
<body>

<div class="card">
    <h2>ARR & DEP Processor</h2>
    <p>Выберите файл для обработки:</p>
    
    <label for="fArr" class="btn btn-arr">СОЗДАТЬ ARR (ПРИЛЕТ)</label>
    <input type="file" id="fArr" onchange="run('ARR')">
    
    <label for="fDep" class="btn btn-dep">СОЗДАТЬ DEPAR (ВЫЛЕТ)</label>
    <input type="file" id="fDep" onchange="run('DEP')">
    
    <div id="status">Ожидание файла...</div>
</div>

<script>
// Вся логика теперь здесь
function run(mode) {
    const input = mode === 'ARR' ? document.getElementById('fArr') : document.getElementById('fDep');
    const file = input.files[0];
    if (!file) return;

    document.getElementById('status').innerText = "Обработка и стилизация...";

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, {type: 'array'});
            const raw = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            
            if (raw.length === 0) throw "Файл пуст";

            // 1. Формируем данные как в макросе
            const processed = raw.map(item => {
                if(mode === 'ARR') {
                    return {
                        "VOUCHER": v(item["Reference #"]), "Hotel": v(item["Hotel"]), "Date of birth": v(item["Date of birth"]),
                        "MR/MRS": v(item["MR/MRS"]), "NAME": v(item["Tourist"]), "PAX": 1,
                        "FLIGHT": v(item["Arrival flight"]), "DATE AND TIME": v(item["Time of arrival flight to"]),
                        "Guide": "-", "Pick up guide": "-", "Services by partner": v(item["Services by partner"])
                    };
                } else {
                    return {
                        "VOUCHER": v(item["Reference #"]), "Hotel": v(item["Hotel"]), "MR/MRS": v(item["MR/MRS"]),
                        "NAME": v(item["Tourist"]), "PAX": 1, "PHONE": "-", "HOTEL GUIDE": "-",
                        "FLIGHT": v(item["Return flight"]), "DATE AND TIME": v(item["Time of return fligh from"]),
                        "PICK UP TIME": "-", "GUIDE": "-", "Pick up GUIDE": "-", "Services by partner": v(item["Services by partner"])
                    };
                }
            });

            const newWb = XLSX.utils.book_new();
            
            // 2. Группировка по рейсам (листы)
            const groups = {"Base": processed};
            processed.forEach(x => {
                let n = clean(x.FLIGHT);
                if(!groups[n]) groups[n] = [];
                groups[n].push(x);
            });

            // 3. Создание листов и применение стилей
            Object.keys(groups).forEach(name => {
                const dataForSheet = name === "Base" ? groups[name] : groups[name].sort((a,b) => String(a.Hotel).localeCompare(b.Hotel));
                const ws = XLSX.utils.json_to_sheet(dataForSheet);

                // Применяем границы, жирный шрифт и цвет шапки
                const range = XLSX.utils.decode_range(ws['!ref']);
                for(let R = range.s.r; R <= range.e.r; ++R) {
                    for(let C = range.s.c; C <= range.e.c; ++C) {
                        const cell = ws[XLSX.utils.encode_cell({c:C, r:R})];
                        if(!cell) continue;
                        
                        cell.s = {
                            border: {
                                top: {style:"thin"}, bottom: {style:"thin"},
                                left: {style:"thin"}, right: {style:"thin"}
                            }
                        };

                        if(R === 0) { // Стиль для шапки
                            cell.s.fill = { fgColor: { rgb: "8EAADA" } };
                            cell.s.font = { bold: true };
                            cell.s.alignment = { horizontal: "center" };
                        }
                    }
                }

                // Авто-ширина колонок
                ws['!cols'] = Object.keys(dataForSheet[0] || {}).map(() => ({wch: 18}));
                XLSX.utils.book_append_sheet(newWb, ws, name);
            });

            XLSX.writeFile(newWb, mode + "_Report_Styled.xlsx");
            document.getElementById('status').innerText = "Готово! Файл скачан.";
        } catch(err) {
            alert("Ошибка: " + err);
            document.getElementById('status').innerText = "Ошибка в данных.";
        }
        input.value = '';
    };
    reader.readAsArrayBuffer(file);
}

function v(val) { return (val === undefined || val === null || String(val).trim() === "") ? "-" : val; }
function clean(n) {
    let res = String(n).replace(/[\\\/\:\*\?\[\]]/g, "_").substring(0, 31);
    return (res.trim() === "" || res === "-") ? "NO_FLIGHT" : res;
}
</script>

</body>
</html>
